name: Optimized Release Build

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master' # ç»§ç»­ä½¿ç”¨ master è§£å†³ä¾èµ–é—®é¢˜
      
      - name: Clean and Get Dependencies
        run: |
          cd simple_live_app
          flutter clean
          flutter pub get

      # ğŸŸ¢ å…³é”®æ­¥éª¤ 1ï¼šç°åœºç”Ÿæˆä¸€ä¸ªçœŸå®çš„ç­¾åè¯ä¹¦ (keystore)
      # è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶çš„è‡ªç­¾åè¯ä¹¦ï¼Œå¯†ç éƒ½æ˜¯ 123456
      - name: Generate Keystore
        run: |
          cd simple_live_app/android
          keytool -genkey -v -keystore app-release.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias my-key-alias \
            -storepass 123456 -keypass 123456 \
            -dname "CN=SimpleLive, OU=IT, O=GitHub, L=Internet, S=Cloud, C=CN"

      # ğŸŸ¢ å…³é”®æ­¥éª¤ 2ï¼šé…ç½® key.properties æŒ‡å‘ä¸Šé¢ç”Ÿæˆçš„è¯ä¹¦
      - name: Configure Keystore Properties
        run: |
          cd simple_live_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=my-key-alias" >> key.properties
          echo "storeFile=app-release.jks" >> key.properties

      # ğŸŸ¢ å…³é”®æ­¥éª¤ 3ï¼šæ„å»º Release åŒ… (å¹¶é’ˆå¯¹æ¶æ„åˆ†åŒ…)
      # --split-per-abi ä¼šç”Ÿæˆä¸‰ä¸ªåŒ…ï¼š
      # 1. arm64-v8a (ç›®å‰90%çš„ä¸»æµæ‰‹æœºç”¨è¿™ä¸ª)
      # 2. armeabi-v7a (è€æ—§æ‰‹æœº)
      # 3. x86_64 (æ¨¡æ‹Ÿå™¨/å¹³æ¿)
      - name: Build Split Release APKs
        run: |
          cd simple_live_app
          flutter build apk --release --split-per-abi --no-tree-shake-icons

      # ä¸Šä¼ äº§ç‰©ï¼šè¿™æ¬¡ä½ ä¼šå¾—åˆ° 3 ä¸ªå°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ 1 ä¸ªå¤§æ–‡ä»¶
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-release-split
          path: simple_live_app/build/app/outputs/flutter-apk/*.apk

name: Arm64 Release Build

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
      
      - name: Clean and Get Dependencies
        run: |
          cd simple_live_app
          flutter clean
          flutter pub get

      # ğŸŸ¢ 1. ç”Ÿæˆè¯ä¹¦ (ä¿æŒåœ¨ app ç›®å½•ä¸‹ï¼Œé˜²æ­¢è·¯å¾„æŠ¥é”™)
      - name: Generate Keystore
        run: |
          cd simple_live_app/android/app
          keytool -genkey -v -keystore app-release.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias my-key-alias \
            -storepass 123456 -keypass 123456 \
            -dname "CN=SimpleLive, OU=IT, O=GitHub, L=Internet, S=Cloud, C=CN"

      # ğŸŸ¢ 2. é…ç½®è·¯å¾„ (ä¿æŒä¹‹å‰çš„ä¿®å¤)
      - name: Configure Keystore Properties
        run: |
          cd simple_live_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=my-key-alias" >> key.properties
          echo "storeFile=app-release.jks" >> key.properties

      # ğŸŸ¢ 3. ç¼–è¯‘ï¼šæŒ‡å®šåªç¼–è¯‘ android-arm64
      # è¿™æ ·ç”Ÿæˆçš„ app-release.apk é‡Œé¢å°±åªæœ‰ arm64 çš„åº“ï¼Œä½“ç§¯å°ä¸”ä¸ç”¨åˆ‡åˆ†
      - name: Build Arm64 Only
        run: |
          cd simple_live_app
          flutter build apk --release --target-platform android-arm64 --no-tree-shake-icons

      # ğŸŸ¢ 4. ä¸Šä¼ 
      # æ³¨æ„ï¼šå•ç›®æ ‡ç¼–è¯‘è¾“å‡ºçš„æ–‡ä»¶åé€šå¸¸æ˜¯ app-release.apk
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-arm64
          path: simple_live_app/build/app/outputs/flutter-apk/app-release.apk
